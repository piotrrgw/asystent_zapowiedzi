<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asystent zapowiedzi ‚Äî PKP Intercity (pe≈Çna wersja)</title>
<style>
:root{--bg:#f6f8fa;--card:#fff;--muted:#6b7280;--accent:#0b6efd;--danger:#dc2626}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:var(--bg);color:#0f172a}
.container{max-width:980px;margin:16px auto;padding:16px}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(12,12,16,0.06)}
h1{margin:0 0 6px;font-size:20px}
.lead{margin:0 0 12px;color:var(--muted);font-size:13px}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:800px){.form-grid{grid-template-columns:1fr}}
label{display:block;font-size:13px;color:#1f2937;margin-bottom:6px}
input,select,textarea{width:100%;padding:10px;border:1px solid #e6edf3;border-radius:8px;font-size:14px;background:#fff}
textarea{min-height:140px;resize:vertical}
.row{display:flex;gap:8px}
.btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-primary{background:var(--accent);color:#fff}
.btn-ghost{background:#f1f5f9;color:#0f172a;border:1px solid #e6edf3}
.small{font-size:13px;color:var(--muted)}
.footer{margin-top:12px;padding-top:12px;border-top:1px dashed #eef2f7;text-align:center;color:var(--muted);font-size:13px}
.preset-list{margin-top:8px}
.kv{font-weight:600}
.bad{color:var(--danger)}
.helper{font-size:12px;color:var(--muted);margin-top:-6px;margin-bottom:8px}
.checkbox-row{display:flex;align-items:center;gap:8px}
.inline{display:inline-block}
</style>
</head>
<body>
<div class="container">
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Asystent zapowiedzi ‚Äî PKP Intercity (pe≈Çna wersja)</h1>
    <p class="lead">Generator ≈õci≈õle zgodny z Wytycznymi i Wzorami komunikat√≥w PKP Intercity (podstawowe + czƒô≈õci A, B, C). Wype≈Çnij dane lub wczytaj pociƒÖg z <code>trains.json</code>.</p>

    <div style="display:grid;gap:12px">
      <div>
        <label>Wybierz pociƒÖg (z trains.json)</label>
        <select id="trainSelect"><option value="">-- brak danych --</option></select>
        <div class="helper">Po wybraniu pociƒÖgu formularz zostanie autouzupe≈Çniony.</div>
      </div>

      <div class="form-grid">
        <div>
          <label for="messageType">Typ komunikatu <span class="small">(wzory podstawowe)</span></label>
          <select id="messageType">
            <option value="">-- wybierz --</option>
            <option value="powitalny_skr_start">Powitalny ‚Äî skr√≥cony startowy</option>
            <option value="powitalny_rozszerzony">Powitalny ‚Äî rozszerzony</option>
            <option value="powitalny_skr">Powitalny ‚Äî skr√≥cony</option>
            <option value="powitalno_pozegnalny">Powitalno-po≈ºegnalny (tranzytowy)</option>
            <option value="pozegnalny">Po≈ºegnalny</option>
          </select>
        </div>

        <div>
          <label for="category">Kategoria pociƒÖgu</label>
          <select id="category">
            <option value="">-- wybierz --</option>
            <option value="EIP">EIP</option>
            <option value="EIC">EIC</option>
            <option value="IC">IC</option>
            <option value="TLK">TLK</option>
            <option value="EC">EC</option>
            <option value="EN">EN</option>
            <option value="ICN">ICN</option>
          </select>
        </div>

        <div>
          <label for="number">Numer pociƒÖgu <span class="small">*</span></label>
          <input id="number" type="text" placeholder="np. 1600">
        </div>

        <div>
          <label for="name">Nazwa pociƒÖgu (opcjonalnie)</label>
          <input id="name" type="text" placeholder="np. ≈Åom≈ºa">
        </div>

        <div>
          <label for="from">Stacja poczƒÖtkowa <span class="small">*</span></label>
          <input id="from" type="text" placeholder="np. Gdynia G≈Ç√≥wna">
        </div>

        <div>
          <label for="to">Stacja ko≈Ñcowa <span class="small">*</span></label>
          <input id="to" type="text" placeholder="np. Warszawa Centralna">
        </div>

        <div>
          <label for="via">Stacja(-e) po≈õrednie <span class="small">(1-2)</span></label>
          <input id="via" type="text" placeholder="oddzielone przecinkiem">
        </div>

        <div>
          <label for="nextStation">Nastƒôpna stacja</label>
          <input id="nextStation" type="text" placeholder="np. Tczew">
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label for="groups">Grupy wagon√≥w (je≈õli dotyczy)</label>
          <input id="groups" type="text" placeholder="np. wagony 1-5 ‚Üí X; 6-8 ‚Üí Y">
        </div>

        <div>
          <label for="conductorCar">Przedzia≈Ç konduktorski ‚Äî wagon nr</label>
          <input id="conductorCar" type="text" placeholder="np. 3">
        </div>

        <div>
          <label for="gastroType">Oferta gastronomiczna</label>
          <select id="gastroType">
            <option value="none">Brak oferty</option>
            <option value="wars">Wagon gastronomiczny WARS</option>
            <option value="vending">Automaty vendingowe</option>
            <option value="minibar">W√≥zek mini-bar</option>
            <option value="wars_and_vending">WARS + automaty</option>
          </select>
        </div>

        <div>
          <label for="gastroInfo">Szczeg√≥≈Çy gastronomii (nr wagonu / do stacji)</label>
          <input id="gastroInfo" type="text" placeholder="np. wagon 7; do stacji Krak√≥w">
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label for="isDelayed">PociƒÖg op√≥≈∫niony?</label>
          <div class="checkbox-row"><input id="isDelayed" type="checkbox"><label class="small inline">zaznacz, je≈õli op√≥≈∫nienie</label></div>
        </div>

        <div>
          <label for="delayMinutes">Minuty op√≥≈∫nienia (je≈õli dotyczy)</label>
          <input id="delayMinutes" type="number" min="0" value="0">
        </div>

        <div style="grid-column:1/3">
          <label for="delayReason">Przyczyna op√≥≈∫nienia (wybierz z katalogu lub wpisz)</label>
          <select id="delayReason">
            <option value="">-- wybierz z katalogu --</option>
            <!-- przyk≈Çadowe opcje z katalogu (u≈ºytkownik mo≈ºe wpisaƒá w≈ÇasnƒÖ) -->
            <option value="awaria_taboru">awaria taboru</option>
            <option value="awaria_sieci_trakcyjnej">awaria sieci trakcyjnej</option>
            <option value="roboty_torowe">roboty torowe</option>
            <option value="inne">inne</option>
          </select>
          <input id="delayReasonCustom" type="text" placeholder="Je≈õli 'inne' ‚Äî wpisz tre≈õƒá" style="margin-top:8px">
        </div>
      </div>

      <div class="form-grid">
        <div>
          <label for="stopDuration">Przewidywany czas postoju na stacji (minuty)</label>
          <input id="stopDuration" type="number" min="0" value="0">
        </div>

        <div>
          <label for="disconnect">Roz≈ÇƒÖczenie wagon√≥w / rozk≈Çad (je≈õli dotyczy)</label>
          <input id="disconnect" type="text" placeholder="np. wagony 1-3 ko≈ÑczƒÖ bieg na stacji X">
        </div>

        <div>
          <label for="transfers">Mo≈ºliwe przesiadki / info o skomunikowaniach</label>
          <input id="transfers" type="text" placeholder="np. mo≈ºliwe przesiadki do pociƒÖgu...">
        </div>

        <div>
          <label for="notes">Dodatkowe uwagi / regulacje</label>
          <input id="notes" type="text" placeholder="np. zamkniƒôte toalety w wagonach 3-4">
        </div>
      </div>

      <!-- Opcje czƒô≈õci A/B/C -->
      <div style="display:grid;gap:8px">
        <label class="kv">Dodatkowe komunikaty (wybierz fragmenty do do≈ÇƒÖczenia)</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <label><input type="checkbox" id="partA1"> A1 ‚Äî jazda pociƒÖgiem op√≥≈∫nionym (zmiana op√≥≈∫nienia)</label>
          <label><input type="checkbox" id="partA2"> A2 ‚Äî wyd≈Çu≈ºony post√≥j</label>
          <label><input type="checkbox" id="partA3"> A3 ‚Äî zatrzymanie przed semaforem</label>
          <label><input type="checkbox" id="partB1"> B1 ‚Äî nieplanowany post√≥j / przerwa w ruchu</label>
          <label><input type="checkbox" id="partB3"> B3 ‚Äî poczƒôstunek awaryjny (op√≥≈∫nienie ‚â•60 min)</label>
          <label><input type="checkbox" id="partC4"> C4 ‚Äî przypomnienie o zakazach (palenie/alkohol)</label>
        </div>
        <div class="helper">Zaznacz fragmenty A/B/C, kt√≥re chcesz dodaƒá ‚Äî generator sam uwzglƒôdni warunki (np. B3 doda siƒô automatycznie gdy op√≥≈∫nienie ‚â•60 min i zaznaczysz B3).</div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button id="generateBtn" class="btn btn-primary">Generuj komunikat</button>
        <button id="copyBtn" class="btn btn-ghost">Kopiuj do schowka</button>
        <button id="exportBtn" class="btn btn-ghost">Eksport .txt</button>
        <button id="clearBtn" class="btn btn-ghost">Wyczy≈õƒá formularz</button>
      </div>

      <div>
        <label>Wygenerowany komunikat</label>
        <textarea id="output" readonly placeholder="Wynik pojawi siƒô tutaj"></textarea>
      </div>

      <div class="preset-list">
        <label class="small">Presety (zapisz, aby szybko wczytaƒá pociƒÖg)</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="presetName" placeholder="Nazwa presetu" />
          <button id="savePreset" class="btn btn-primary">Zapisz preset</button>
        </div>
        <div id="presets" style="margin-top:8px"></div>
      </div>

    </div>

    <div class="footer">
      Wsp√≥≈Çautorzy: ChatGPT i Piotr MüöÇ
    </div>

  </div>
</div>

<script>
/*
  Pe≈Çna implementacja generatora zapowiedzi zgodnie z dokumentem Wytyczne i Wzory komunikat√≥w PKP IC (2025).
  - Sk≈Çadamy komunikat z fragment√≥w wg regu≈Ç: podstawowe, A, B, C.
  - Pomijamy fragmenty gdy brak danych.
  - Dodajemy fragmenty warunkowe (np. je≈õli op√≥≈∫nienie >=5 min dodajemy 'Przepraszamy za op√≥≈∫nienie' w powitalnych).
  - B3 (poczƒôstunek awaryjny) sugerowany gdy op√≥≈∫nienie >= 60 i zaznaczone.
  - Presets i localStorage.
  - trains.json ≈Çadowane asynchronicznie (u≈ºytkownik wype≈Çni).
*/

// helpers
const $ = id => document.getElementById(id);
const lsget = k => {
  try { return JSON.parse(localStorage.getItem(k)); } catch(e){ return null; }
};
const lsset = (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} };

let trains = [];

// load trains.json (skeleton file must be provided by user)
fetch('trains.json')
  .then(r => r.json())
  .then(data => {
    trains = Array.isArray(data) ? data : (data.trains || []);
    const sel = $('trainSelect');
    sel.innerHTML = '<option value="">-- wybierz pociƒÖg --</option>';
    trains.forEach((t,i) => {
      const opt = document.createElement('option');
      opt.value = i;
      const name = t.name ? ` ${t.name}` : '';
      opt.textContent = `${t.category || ''} ${t.number || ''}${name} ‚Äî ${t.route?.from || ''} ‚Üí ${t.route?.to || ''}`;
      sel.appendChild(opt);
    });
    // restore trainSelect from saved state
    const saved = lsget('az_selectedTrain');
    if (saved != null && saved < trains.length) sel.value = saved;
  })
  .catch(e => {
    console.warn('Nie znaleziono trains.json lub b≈ÇƒÖd wczytywania. Upewnij siƒô, ≈ºe plik istnieje i jest poprawny JSON.', e);
  });

// load saved form values
function loadForm() {
  const s = lsget('az_form');
  if (!s) return;
  for (const k in s) {
    if ($(k)) $(k).value = s[k];
  }
  if (s.isDelayed) $('isDelayed').checked = true;
  if (s.parts) {
    ['A1','A2','A3','B1','B3','C4'].forEach(p => {
      const el = {
        A1: 'partA1', A2: 'partA2', A3: 'partA3', B1: 'partB1', B3: 'partB3', C4: 'partC4'
      }[p];
      if (el && s.parts.includes(p)) $(el).checked = true;
    });
  }
}
function saveForm() {
  const obj = {
    messageType: $('messageType').value,
    category: $('category').value,
    number: $('number').value,
    name: $('name').value,
    from: $('from').value,
    to: $('to').value,
    via: $('via').value,
    nextStation: $('nextStation').value,
    groups: $('groups').value,
    conductorCar: $('conductorCar').value,
    gastroType: $('gastroType').value,
    gastroInfo: $('gastroInfo').value,
    isDelayed: $('isDelayed').checked,
    delayMinutes: Number($('delayMinutes').value || 0),
    delayReason: $('delayReason').value,
    delayReasonCustom: $('delayReasonCustom').value,
    stopDuration: Number($('stopDuration').value || 0),
    disconnect: $('disconnect').value,
    transfers: $('transfers').value,
    notes: $('notes').value,
  };
  // parts
  const parts = [];
  if ($('partA1').checked) parts.push('A1');
  if ($('partA2').checked) parts.push('A2');
  if ($('partA3').checked) parts.push('A3');
  if ($('partB1').checked) parts.push('B1');
  if ($('partB3').checked) parts.push('B3');
  if ($('partC4').checked) parts.push('C4');
  obj.parts = parts;
  lsset('az_form', obj);
  // selected train
  lsset('az_selectedTrain', $('trainSelect').value === '' ? null : Number($('trainSelect').value));
}

// wire saving on change
[
  'messageType','category','number','name','from','to','via','nextStation','groups','conductorCar',
  'gastroType','gastroInfo','isDelayed','delayMinutes','delayReason','delayReasonCustom','stopDuration',
  'disconnect','transfers','notes','trainSelect'
].forEach(id => {
  const el = $(id);
  if (!el) return;
  el.addEventListener('input', () => {
    saveForm();
  });
  el.addEventListener('change', () => {
    saveForm();
  });
});

// load saved on start
document.addEventListener('DOMContentLoaded', () => {
  // restore presets list
  renderPresets();
  loadForm();
  // if trainSelect chosen, fill form
  const idx = lsget('az_selectedTrain');
  if (idx != null && $('trainSelect') && $('trainSelect').options.length > idx) {
    $('trainSelect').value = idx;
    fillFromTrain(idx);
  }
});

// when user selects train from trains.json
$('trainSelect')?.addEventListener('change', (e) => {
  const idx = e.target.value;
  if (idx === '') return;
  fillFromTrain(idx);
  lsset('az_selectedTrain', Number(idx));
});

function fillFromTrain(idx) {
  if (!trains[idx]) return;
  const t = trains[idx];
  $('category').value = t.category || $('category').value;
  $('number').value = t.number || $('number').value;
  $('name').value = t.name || $('name').value;
  $('from').value = t.route?.from || $('from').value;
  $('to').value = t.route?.to || $('to').value;
  $('via').value = (Array.isArray(t.route?.via) ? t.route.via.join(', ') : (t.route?.via || $('via').value));
  $('nextStation').value = (Array.isArray(t.nextStations) ? t.nextStations[0] : (t.nextStations || $('nextStation').value));
  $('gastroType').value = t.gastro?.type || $('gastroType').value;
  $('gastroInfo').value = t.gastro?.info || $('gastroInfo').value;
  $('conductorCar').value = t.conductorCar || $('conductorCar').value;
  saveForm();
}

// TEXT BUILDERS ‚Äî follow PDF structure exactly
function fragHeaderGreeting() {
  return 'Dzie≈Ñ dobry! / Dobry wiecz√≥r!';
}
function fragWelcomeTrain(cat, num, name) {
  const namePart = name ? ` ${name}` : '';
  return `Witamy w pociƒÖgu ${cat} ${num}${namePart}`;
}
function fragRel(from,to,viaStr) {
  let s = `, ze stacji ${from} do stacji ${to}`;
  if (viaStr) s += `, przez ${viaStr}`;
  s += '.';
  return s;
}
function fragNextStation(next) {
  return next ? `Nastƒôpna stacja ${next}.` : '';
}
function fragGroups(groups) {
  return groups ? `PociƒÖg prowadzi grupƒô/grupy wagon√≥w: ${groups}.` : '';
}
function fragDelayInfo(delayMin, reason) {
  if (!delayMin || delayMin <= 0) return '';
  const minWord = (delayMin === 1) ? 'minutƒô' : 'minut';
  const reasonText = reason || '...';
  return `Informujemy, ≈ºe w zwiƒÖzku z ${reasonText} pociƒÖg jest op√≥≈∫niony o ${delayMin} ${minWord}. Przepraszamy za op√≥≈∫nienie. Osoby przesiadajƒÖce siƒô do innych pociƒÖg√≥w prosimy o zg≈Çaszanie tego zamiaru dru≈ºynie konduktorskiej.`;
}
function fragConductorCar(car) {
  return car ? `Przedzia≈Ç konduktorski znajduje siƒô w wagonie numer ${car}.` : '';
}
function fragFreeSnack() {
  return `W trakcie podr√≥≈ºy otrzymajƒÖ Pa≈Ñstwo poczƒôstunek.`;
}
function fragGastronomy(type, info) {
  // Uses patterns from PDF (see pages quoted)
  if (!type || type === 'none') return `Informujemy, ≈ºe w pociƒÖgu oferta gastronomiczna nie jest dostƒôpna, za co Pa≈Ñstwa przepraszamy.`;
  if (type === 'wars') {
    if (info) return `Zapraszamy do skorzystania z oferty gastronomicznej WARS, w wagonie numer ${info}.`;
    return `Zapraszamy do skorzystania z oferty gastronomicznej WARS.`;
  }
  if (type === 'vending') {
    if (info) return `Zapraszamy do zakupu napoj√≥w i przekƒÖsek w automatach, w wagonie/wagonach numer ${info}.`;
    return `Zapraszamy do zakupu napoj√≥w i przekƒÖsek w automatach.`;
  }
  if (type === 'minibar') {
    if (info) return `Zapraszamy do zakupu napoj√≥w i przekƒÖsek z w√≥zka mini-bar. Oferta dostƒôpna bƒôdzie do stacji ${info}.`;
    return `Zapraszamy do zakupu napoj√≥w i przekƒÖsek z w√≥zka mini-bar.`;
  }
  if (type === 'wars_and_vending') {
    // info may contain "wagon 7; vending 10"
    const parts = (info || '').split(';').map(s=>s.trim()).filter(Boolean);
    let wars = '', vend = '';
    parts.forEach(p=>{
      if (/wars|wagon/i.test(p)) wars = p.replace(/wars|wagon/i,'').trim();
      else vend = p;
    });
    let out = 'Zapraszamy do skorzystania z oferty gastronomicznej WARS';
    if (wars) out += `, w wagonie numer ${wars}`;
    out += '.';
    if (vend) out += ` Dodatkowo dostƒôpne sƒÖ automaty vendingowe w wagonach ${vend}.`;
    return out;
  }
  return '';
}
function fragSafetyNotice() {
  return `W trosce o Pa≈Ñstwa komfort i bezpiecze≈Ñstwo, prosimy o zapoznanie siƒô z informacjami zamieszczonymi w wagonach. Dru≈ºyna konduktorska pozostaje do Pa≈Ñstwa dyspozycji i s≈Çu≈ºy pomocƒÖ w trakcie ca≈Çej podr√≥≈ºy.`;
}
function fragFarewells() {
  return `Osoby wysiadajƒÖce prosimy o zabranie swoich rzeczy oraz zachowanie ostro≈ºno≈õci. Dziƒôkujemy za podr√≥≈º z PKP Intercity.`;
}
function fragStopDuration(min) {
  if (!min || min < 1) return '';
  return `Przewidywany czas postoju na stacji wynosi oko≈Ço ${min} minut.`;
}
function fragPlannedDeparture(timeStr) {
  return timeStr ? `Planowy/Przewidywany odjazd pociƒÖgu o godzinie ${timeStr}.` : '';
}
function fragDisconnectInfo(disconnect) {
  return disconnect ? `${disconnect}` : '';
}
function fragTransferInfo(transfers) {
  return transfers ? `Informujemy o mo≈ºliwo≈õci przesiadek: ${transfers}.` : '';
}
function fragA1() {
  return `Informujemy, ≈ºe pociƒÖg jedzie zgodnie z rozk≈Çadem jazdy.`;
}
function fragA2(delayMin, reason) {
  return `Informujemy, ≈ºe w zwiƒÖzku z ${reason || '...'} pociƒÖg odjedzie z op√≥≈∫nieniem oko≈Ço ${delayMin} minut. O zmianie op√≥≈∫nienia bƒôdziemy informowaƒá na bie≈ºƒÖco. Przepraszamy za niedogodno≈õci.`;
}
function fragA3(next, minutes) {
  return `Informujemy, ≈ºe nasz pociƒÖg wjedzie na stacjƒô ${next || '...'} za oko≈Ço ${minutes} minut. Ze wzglƒôd√≥w bezpiecze≈Ñstwa, otwieranie drzwi wyj≈õciowych oraz opuszczanie pociƒÖgu jest zabronione.`;
}
function fragB1() {
  return `Informujemy, ≈ºe nastƒÖpi≈Ça nieprzewidziana przerwa w ruchu. Przepraszamy za niedogodno≈õci i prosimy o wyrozumia≈Ço≈õƒá. W chwili obecnej ustalamy przyczyny nieplanowego postoju pociƒÖgu.`;
}
function fragB3(poczƒôstunekDesc) {
  return `Prosimy o uwagƒô! Informujemy, ≈ºe w zwiƒÖzku z op√≥≈∫nieniem pociƒÖgu istnieje mo≈ºliwo≈õƒá otrzymania poczƒôstunku awaryjnego: ${poczƒôstunekDesc || 'szczeg√≥≈Çy u dru≈ºyny konduktorskiej'}.`;
}
function fragC4() {
  return `Przypominamy, ≈ºe w pociƒÖgu obowiƒÖzuje ca≈Çkowity zakaz palenia wyrob√≥w tytoniowych i papieros√≥w elektronicznych. Niezastosowanie siƒô do zakazu mo≈ºe spowodowaƒá awaryjne zatrzymanie pociƒÖgu.`;
}

// main build function
function generate() {
  // collect fields
  const type = $('messageType').value;
  const category = $('category').value;
  const number = $('number').value.trim();
  const name = $('name').value.trim();
  const from = $('from').value.trim();
  const to = $('to').value.trim();
  const via = $('via').value.trim();
  const next = $('nextStation').value.trim();
  const groups = $('groups').value.trim();
  const conductorCar = $('conductorCar').value.trim();
  const gastroType = $('gastroType').value;
  const gastroInfo = $('gastroInfo').value.trim();
  const isDelayed = $('isDelayed').checked;
  const delayMinutes = Number($('delayMinutes').value || 0);
  const delayReason = ($('delayReason').value === 'inne') ? $('delayReasonCustom').value.trim() : $('delayReason').value;
  const stopDuration = Number($('stopDuration').value || 0);
  const disconnect = $('disconnect').value.trim();
  const transfers = $('transfers').value.trim();
  const notes = $('notes').value.trim();

  // parts selection
  const parts = {
    A1: $('partA1').checked,
    A2: $('partA2').checked,
    A3: $('partA3').checked,
    B1: $('partB1').checked,
    B3: $('partB3').checked,
    C4: $('partC4').checked
  };

  // validation required by document: type, category, number, from, to
  const missing = [];
  if (!type) missing.push('typ komunikatu');
  if (!category) missing.push('kategoria pociƒÖgu');
  if (!number) missing.push('numer pociƒÖgu');
  if (!from) missing.push('stacja poczƒÖtkowa');
  if (!to) missing.push('stacja ko≈Ñcowa');
  if (missing.length) {
    alert('Brakuje wymaganych danych: ' + missing.join(', ') + '. Nie mo≈ºna wygenerowaƒá komunikatu.');
    return;
  }

  // Start building following exact fragment rules and order from PDF
  let out = '';

  // Greeting for powitalne templates
  if (type.startsWith('powitalny')) {
    out += fragHeaderGreeting() + '\n';
    out += fragWelcomeTrain(category, number, name);
    out += fragRel(from, to, via ? via.split(',').map(s=>s.trim()).filter(Boolean).slice(0,2).join(', ') : '');
    out += '\n';
    // if groups present and multi-group logic: include groups fragment (document requires)
    if (groups) out += fragGroups(groups) + '\n';
    // Next station
    if (next) out += fragNextStation(next) + '\n';
    // Delay info for powitalny_rozszerzony (and powitalny_skr_start: if specified)
    if (isDelayed && delayMinutes >= 1) {
      // PDF: if op√≥≈∫nienie >=5 add "Przepraszamy..." ‚Äî but add delay info always when present
      out += fragDelayInfo(delayMinutes, delayReason) + '\n';
      if (delayMinutes >= 5) {
        out += 'Przepraszamy za op√≥≈∫nienie pociƒÖgu.\n';
      }
    }
    // conductor car
    if (conductorCar) out += fragConductorCar(conductorCar) + '\n';
    // free snack (not modeled by field now) - skipped unless notes instruct
  }

  // For powitalno-po≈ºegnalny / pozegnalny, different opening
  if (type === 'powitalno_pozegnalny') {
    // shortened tranzytowy pattern
    if (next) out += `Zbli≈ºamy siƒô do stacji ${next}.\n`; else out += `Zbli≈ºamy siƒô do stacji.\n`;
    if (isDelayed && delayMinutes >= 5) out += 'Przepraszamy za op√≥≈∫nienie pociƒÖgu.\n';
    if (stopDuration >= 5) out += fragStopDuration(stopDuration) + '\n';
    if (disconnect) out += `Przypominamy, ≈ºe na stacji ${disconnect} pociƒÖg zostanie roz≈ÇƒÖczony.\n`;
  }

  if (type === 'pozegnalny') {
    out += `Zbli≈ºamy siƒô do stacji / stacji ko≈Ñcowej ${to}.\n`;
    if (isDelayed && delayMinutes >= 5) out += 'Przepraszamy za op√≥≈∫nienie pociƒÖgu.\n';
    if (stopDuration >= 5) out += fragStopDuration(stopDuration) + '\n';
    if (disconnect) out += fragDisconnectInfo(disconnect) + '\n';
    out += 'Osoby wysiadajƒÖce prosimy o zabranie swoich rzeczy oraz zachowanie ostro≈ºno≈õci. Dziƒôkujemy za podr√≥≈º z PKP Intercity.\n';
  }

  // Gastronomy ‚Äî document prescribes: if available, add; if not ‚Äî apology with alternatives
  // The PDF uses different variants depending on template: we keep the standardized phrases.
  // For powitalne: if op√≥≈∫nienie >=5 also add "Zapraszamy do skorzystania..." per doc.
  // We'll include the gastronomic fragment in most templates unless template explicitly avoids.
  const gastroFrag = fragGastronomy(gastroType, gastroInfo);
  // If powitalny_rozszerzony and isDelayed >=5 -> add "Zapraszamy..."
  if (type.startsWith('powitalny')) {
    out += gastroFrag + '\n';
  } else if (type === 'pozegnalny' || type === 'powitalno_pozegnalny') {
    // include gastronomic info as well
    out += gastroFrag + '\n';
  }

  // Safety and crew info always at end of base templates
  if (type.startsWith('powitalny')) {
    out += fragSafetyNotice() + '\n';
  }

  // Add conductor car info again if not yet added in other block (ensure present)
  if (!type.startsWith('powitalny') && conductorCar) out += fragConductorCar(conductorCar) + '\n';

  // Add additional parts A/B/C as selected AND as allowed by conditions in document
  // A1: jazda pociƒÖgiem op√≥≈∫nionym ‚Äî applicable when pociag by≈Ç op√≥≈∫niony i teraz jedzie zgodnie
  if (parts.A1) {
    out += fragA1() + '\n';
  }
  // A2: wyd≈Çu≈ºony post√≥j - when stopDuration increased (user selects); we include reason/minutes
  if (parts.A2) {
    out += fragA2(stopDuration || delayMinutes, delayReason) + '\n';
  }
  // A3: zatrzymanie przed semaforem
  if (parts.A3) {
    out += fragA3(next, delayMinutes || '...') + '\n';
  }
  // B1: not planned stop /break in traffic ‚Äî include if selected
  if (parts.B1) {
    out += fragB1() + '\n';
    out += 'Ze wzglƒôd√≥w bezpiecze≈Ñstwa, otwieranie drzwi wyj≈õciowych oraz opuszczanie pociƒÖgu jest zabronione.\n';
  }
  // B3: poczƒôstunek awaryjny ‚Äî document: include if op√≥≈∫nienie >=60 and possibility exists
  if (parts.B3 || (isDelayed && delayMinutes >= 60)) {
    // if user selected B3 or condition met, include B3 template ‚Äî ask for details? use transfers/notes or generic
    const pocz = notes || 'poczƒôstunek/detal na stacji; prosimy o zg≈Çaszanie siƒô do dru≈ºyny konduktorskiej';
    out += fragB3(pocz) + '\n';
  }
  // C4: non-compliance reminders
  if (parts.C4) out += fragC4() + '\n';

  // Transfers / skomunikowania ‚Äî document: must be in po≈ºegnalny and powitalno-po≈ºegnalny when applicable
  if (transfers && (type === 'pozegnalny' || type === 'powitalno_pozegnalny')) {
    out += fragTransferInfo(transfers) + '\n';
  }

  // If groups present and we didn't add earlier in powitalny branch for non-powitalny, include
  if (!type.startsWith('powitalny') && groups) out += fragGroups(groups) + '\n';

  // Add notes (like closure of toilets etc.)
  if (notes) out += notes + '\n';

  // End common footer if not already included
  if (!(type === 'pozegnalny')) out += 'Dziƒôkujemy za uwagƒô.\n';

  // final trimming and ensure no sequences of empty lines
  out = out.split('\n').map(s => s.trim()).filter((s,i,arr)=> !(s==='')).join('\n') + '\n';
  $('output').value = out;
  saveForm();
}

// copy to clipboard
$('copyBtn')?.addEventListener('click', () => {
  const txt = $('output').value;
  if (!txt) { alert('Brak wygenerowanego komunikatu.'); return; }
  navigator.clipboard.writeText(txt).then(()=> alert('Skopiowano do schowka')).catch(e=>alert('B≈ÇƒÖd kopiowania: '+e));
});

// generate button
$('generateBtn').addEventListener('click', generate);

// export .txt
$('exportBtn').addEventListener('click', () => {
  const txt = $('output').value;
  if (!txt) { alert('Brak komunikatu do eksportu'); return; }
  const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `komunikat_${$('number').value || 'pociag'}.txt`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// clear
$('clearBtn').addEventListener('click', () => {
  if (!confirm('Wyczy≈õciƒá formularz i lokalne dane?')) return;
  document.getElementById('form').reset();
  $('output').value = '';
  localStorage.removeItem('az_form');
  localStorage.removeItem('az_presets');
  localStorage.removeItem('az_selectedTrain');
  renderPresets();
});

// Presets: save/load
function renderPresets(){
  const node = $('presets');
  node.innerHTML = '';
  const p = lsget('az_presets') || {};
  const keys = Object.keys(p);
  if (!keys.length) { node.innerHTML = '<div class="small">Brak preset√≥w</div>'; return; }
  keys.forEach(k=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginTop='6px';
    const span = document.createElement('div'); span.textContent = k; span.className='small';
    const actions = document.createElement('div');
    const load = document.createElement('button'); load.textContent='Wczytaj'; load.className='btn btn-ghost'; load.style.marginRight='6px';
    const del = document.createElement('button'); del.textContent='Usu≈Ñ'; del.className='btn btn-ghost';
    load.addEventListener('click', ()=>{ loadPreset(k); });
    del.addEventListener('click', ()=>{ if(confirm('Usu≈Ñ preset '+k+'?')) { const pr = lsget('az_presets')||{}; delete pr[k]; lsset('az_presets', pr); renderPresets(); } });
    actions.appendChild(load); actions.appendChild(del);
    div.appendChild(span); div.appendChild(actions);
    node.appendChild(div);
  });
}
$('savePreset').addEventListener('click', ()=> {
  const name = $('presetName').value.trim();
  if (!name) { alert('Podaj nazwƒô presetu'); return; }
  const p = lsget('az_presets') || {};
  const form = lsget('az_form') || {};
  p[name] = form;
  lsset('az_presets', p);
  $('presetName').value = '';
  renderPresets();
  alert('Zapisano preset: '+name);
});
function loadPreset(name) {
  const p = lsget('az_presets') || {};
  const form = p[name];
  if (!form) return;
  // apply
  for (const k in form) {
    if ($(k)) $(k).value = form[k];
  }
  // parts
  ['A1','A2','A3','B1','B3','C4'].forEach(pf => {
    const el = {A1:'partA1',A2:'partA2',A3:'partA3',B1:'partB1',B3:'partB3',C4:'partC4'}[pf];
    if (el) $(el).checked = (form.parts || []).includes(pf);
  });
  saveForm();
  alert('Wczytano preset: '+name);
}

// initial render of presets
renderPresets();

</script>

</body>
</html>
